<script setup lang="ts">
import { library } from "@fortawesome/fontawesome-svg-core";
import { faTrashAlt } from "@fortawesome/free-regular-svg-icons";
import { faPalette } from "@fortawesome/free-solid-svg-icons";
import { FontAwesomeIcon } from "@fortawesome/vue-fontawesome";
import { type UseElementBoundingReturn, useFocusWithin } from "@vueuse/core";
import { BButton, BButtonGroup } from "bootstrap-vue";
import { sanitize } from "dompurify";
import { computed, onMounted, reactive, ref, watch } from "vue";

import { useWorkflowStores } from "@/composables/workflowStores";
import type { TextWorkflowAnnotation, WorkflowAnnotationColour } from "@/stores/workflowEditorAnnotationStore";

import { colours } from "./colours";
import { useResizable } from "./useResizable";
import { selectAllText } from "./utilities";

import ColourSelector from "./ColourSelector.vue";
import DraggablePan from "@/components/Workflow/Editor/DraggablePan.vue";

library.add(faTrashAlt, faPalette);

const props = defineProps<{
    annotation: TextWorkflowAnnotation;
    rootOffset: UseElementBoundingReturn;
    scale: number;
    readonly?: boolean;
}>();

const emit = defineEmits<{
    (e: "change", data: TextWorkflowAnnotation["data"]): void;
    (e: "resize", size: [number, number]): void;
    (e: "move", position: [number, number]): void;
    (e: "pan-by", position: { x: number; y: number }): void;
    (e: "remove"): void;
    (e: "set-colour", colour: WorkflowAnnotationColour): void;
}>();

const resizeContainer = ref<HTMLDivElement>();

useResizable(
    resizeContainer,
    computed(() => props.annotation.size),
    ([width, height]) => {
        emit("resize", [width, height]);
        saveText();
    }
);

function escapeAndSanitize(text: string) {
    return sanitize(text, { ALLOWED_TAGS: ["br"] }).replace(/(?:^(\s|&nbsp;)+)|(?:(\s|&nbsp;)+$)/g, "");
}

const editableElement = ref<HTMLSpanElement>();

function getInnerText() {
    const element = editableElement.value;

    if (element) {
        const value = element.innerHTML ?? "";
        return escapeAndSanitize(value);
    } else {
        return "";
    }
}

function saveText() {
    emit("change", { ...props.annotation.data, text: getInnerText() });
}

function toggleBold() {
    if (props.annotation.data.bold) {
        const { bold: _bold, ...data } = props.annotation.data;
        emit("change", data);
    } else {
        emit("change", { ...props.annotation.data, bold: true });
    }
}

function toggleItalic() {
    if (props.annotation.data.italic) {
        const { italic: _italic, ...data } = props.annotation.data;
        emit("change", data);
    } else {
        emit("change", { ...props.annotation.data, italic: true });
    }
}

const fontSize = computed(() => props.annotation.data.size);
const canIncreaseFontSize = computed(() => fontSize.value < 5);
const canDecreaseFontSize = computed(() => fontSize.value > 1);

function increaseFontSize() {
    if (canIncreaseFontSize.value) {
        emit("change", { ...props.annotation.data, size: fontSize.value + 1 });
    }
}

const increaseFontSizeTitle = computed(() =>
    canIncreaseFontSize.value ? `Increase font size to ${fontSize.value + 1}` : "Maximum font size"
);

function decreaseFontSize() {
    if (canDecreaseFontSize.value) {
        emit("change", { ...props.annotation.data, size: fontSize.value - 1 });
    }
}

const decreaseFontSizeTitle = computed(() =>
    canDecreaseFontSize.value ? `Decrease font size to ${fontSize.value - 1}` : "Minimum font size"
);

function onRootClick() {
    editableElement.value?.focus();
}

function onMove(position: { x: number; y: number }) {
    emit("move", [position.x, position.y]);
}

const showColourSelector = ref(false);
const rootElement = ref<HTMLDivElement>();

const { focused } = useFocusWithin(rootElement);

watch(
    () => focused.value,
    () => {
        if (!focused.value) {
            showColourSelector.value = false;

            if (getInnerText() === "") {
                emit("remove");
            } else {
                saveText();
            }
        }
    }
);

function onSetColour(colour: WorkflowAnnotationColour) {
    emit("set-colour", colour);
}

const cssVariables = computed(() => {
    const vars: Record<string, string> = {
        "--font-size": `${fontSize.value}rem`,
    };

    if (props.annotation.colour !== "none") {
        vars["--font-colour"] = colours[props.annotation.colour];
    }

    return vars;
});

const { annotationStore } = useWorkflowStores();

function onDoubleClick() {
    if (editableElement.value) {
        selectAllText(editableElement.value);
    }
}

onMounted(() => {
    if (annotationStore.isJustCreated(props.annotation.id) && editableElement.value) {
        selectAllText(editableElement.value);
    }
});
</script>

<template>
    <div ref="rootElement" class="text-workflow-annotation">
        <!-- eslint-disable-next-line vuejs-accessibility/no-static-element-interactions vuejs-accessibility/click-events-have-key-events -->
        <div
            ref="resizeContainer"
            class="resize-container"
            :class="{ resizable: !props.readonly, 'prevent-zoom': !props.readonly }"
            :style="cssVariables"
            @click="onRootClick">
            <DraggablePan
                v-if="!props.readonly"
                :root-offset="reactive(props.rootOffset)"
                :scale="props.scale"
                class="draggable-pan"
                @move="onMove"
                @mouseup="saveText"
                @pan-by="(p) => emit('pan-by', p)" />
            <!-- eslint-disable-next-line vuejs-accessibility/no-static-element-interactions -->
            <span
                ref="editableElement"
                :contenteditable="!props.readonly"
                class="prevent-zoom"
                spellcheck="false"
                :class="{
                    bold: props.annotation.data.bold,
                    italic: props.annotation.data.italic,
                }"
                @blur="saveText"
                @mouseup.stop
                @dblclick.prevent="onDoubleClick"
                v-html="escapeAndSanitize(props.annotation.data.text)" />
        </div>

        <BButtonGroup v-if="!props.readonly" class="style-buttons">
            <BButton
                class="button font-weight-bold prevent-zoom"
                variant="outline-primary"
                :title="props.annotation.data.bold ? 'Reset bold' : 'Make bold'"
                :pressed="props.annotation.data.bold"
                @click="toggleBold">
                B
            </BButton>
            <BButton
                class="button font-italic prevent-zoom"
                variant="outline-primary"
                :title="props.annotation.data.italic ? 'Reset italic' : 'Make italic'"
                :pressed="props.annotation.data.italic"
                @click="toggleItalic">
                I
            </BButton>
            <BButton
                class="button prevent-zoom"
                variant="outline-primary"
                title="Colour"
                :pressed="showColourSelector"
                @click="() => (showColourSelector = !showColourSelector)">
                <FontAwesomeIcon icon="fa-palette" class="prevent-zoom" />
            </BButton>
            <BButton
                class="button prevent-zoom"
                variant="primary"
                :title="decreaseFontSizeTitle"
                @click="decreaseFontSize">
                <FontAwesomeIcon :icon="['gxd', 'textSmaller']" class="prevent-zoom" />
            </BButton>
            <BButton
                class="button prevent-zoom"
                variant="primary"
                :title="increaseFontSizeTitle"
                @click="increaseFontSize">
                <FontAwesomeIcon :icon="['gxd', 'textLarger']" class="prevent-zoom" />
            </BButton>
            <BButton class="button prevent-zoom" variant="dark" title="Delete annotation" @click="() => emit('remove')">
                <FontAwesomeIcon icon="far fa-trash-alt" class="prevent-zoom" />
            </BButton>
        </BButtonGroup>

        <ColourSelector
            v-if="showColourSelector"
            class="colour-selector"
            :colour="props.annotation.colour"
            @set-colour="onSetColour" />
    </div>
</template>

<style scoped lang="scss">
@import "theme/blue.scss";
@import "buttonGroup.scss";

.text-workflow-annotation {
    position: absolute;
    width: 100%;
    height: 100%;
    z-index: 200;

    &:focus-within {
        .style-buttons {
            visibility: visible;
        }

        .colour-selector {
            visibility: visible;
        }

        .resize-container {
            resize: both;
            border-color: $brand-primary;
        }
    }

    .style-buttons {
        visibility: hidden;
        @include button-group-style;
    }
}

.resize-container {
    --font-size: 1rem;
    --font-colour: #{$brand-primary};

    color: var(--font-colour);
    font-size: var(--font-size);

    width: 100%;
    height: 100%;

    min-height: calc(1em + 10px);
    min-width: calc(1em + 20px);

    border-color: transparent;
    border-radius: 0.25rem;
    border-width: 2px;
    border-style: solid;

    overflow: hidden;

    position: absolute;

    span {
        position: absolute;
        margin: 5px 10px;
        line-height: 1;

        &.bold {
            font-weight: 700;
        }

        &.italic {
            font-style: italic;
        }

        &:focus,
        &:focus-visible {
            border: none;
            outline: none;
        }
    }

    .draggable-pan {
        cursor: move;
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
    }

    &.resizable:focus-within,
    &.resizable:focus {
        resize: both;
        border-color: $brand-primary;
    }
}

.colour-selector {
    visibility: hidden;
    right: 0.75rem;
    top: -4.5rem;
}
</style>
